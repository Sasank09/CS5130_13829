<?php
require_once "../includes/utility.php";
$today_tasks = '';
$warning_tasks = '';
$upcoming_tasks = '';
session_start();
if (!isset($_SESSION['user_mail']) && $_SESSION['user_mail'] == '') {
    header("refresh:0;url=" . INDEX_PAGE_LOCATION);
} else {
    $currentUserData = getUserDetails($_SESSION['user_mail']);
    $currentDate = date("Y-m-d", time());
    $currentTime = date("H:i:s", time());

    if ($currentUserData['user_id'] != '') {
        $param = array(
            "uid" => $currentUserData['user_id'],
        );

        $sql = "SELECT * FROM todos WHERE user_id =:uid ORDER BY due_date, priority ASC";
        $all = executeQuery($sql, $param, "ALL");
    }
}
?>
<!doctype html>
<html lang="en">

<head>
    <?php getHead(); ?>
</head>

<body>
    <?php getHeader(); ?>
    <div id="cover-spin"></div>
    <div id="viewAllContainer" class="container">
        <div id="status_change"></div>
        <div class="row">
            <?php
            echo "<p class='text-center'><a href='' class='text-danger fw-bold fs-4'>Today's Todos</a></p>";
            foreach ($all as $todo) {
                $str = strtotime($todo['due_date']);
                $todo_date =  date("Y-m-d", $str);
                $todo_time = date("H:i:s", $str);
                if ($todo_date == $currentDate && $todo_time >= $currentTime) {
            ?>
                    <div class="col-lg-3 col-md-6 mb-5">
                        <?php displayCard($todo); ?>
                    </div>
                <?php
                } elseif (($todo_date == $currentDate || $todo_date < $currentDate) && $todo_time < $currentTime) {
                ?>
                    <div class="col-lg-3 col-md-6 mb-5">
                        <?php displayCard($todo); ?>
                    </div>
                <?php
                } elseif ($todo_date > $currentDate) {
                ?>
                    <div class="col-lg-3 col-md-6 mb-5">
                        <?php displayCard($todo); ?>
                    </div>
            <?php
                }
            }
            ?>
        </div>
    </div>

    <?php getFooter(); ?>
    <script type="text/javascript">
        "use strict;"

        function updateStatus(id) {
            console.log("HELLO")
            var todoId = id;
            console.log("todoId: " + todoId);
            $("#cover-spin").show();
            var json = {
                "id": todoId,
                "markComplete": "Clicked"
            }
            console.log(json)
            $.post("crud_todos.php", json, function(response) {
                data = JSON.parse(response);
                console.log(data);
                if (data.status == "Success") {
                    $("#status_change").html(
                        "<div class='alert alert-success'>" + sanitizeHTML(data.message) + "</div>"
                    ).show().delay(500).fadeOut();
                } else {
                    $("#status_change").html(
                        "<div class='alert alert-danger'>" + sanitizeHTML(data.message) + "</div>"
                    );
                }
                $("#cover-spin").delay(500).fadeOut();
                setTimeout(function() {
                    window.location.reload();
                }, 500);
            }).fail(function() {
                alert("error");
            });
        }

        $(document).ready(function() {
            $("#cover-spin").show().delay(500).fadeOut();
        });
    </script>
</body>

</html>